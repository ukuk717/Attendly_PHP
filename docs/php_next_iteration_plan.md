# PHP実装 次イテレーション計画（2025-11-23）

## 目的と前提
- `docs/php_next_steps.md` の **# 移行のゴール** に沿い、既存 Node/Lambda 仕様との差分を作らず PHP 版を仕上げる。
- ロリポップ！スタンダードプランの仕様（`lolipop_server_spec.html`／`migrate_php.md`）内で動作する構成を維持する。
- セキュリティ最優先（CSRF/XSS/ヘッダインジェクション/レートリミット）で、UI は既存環境の見た目・導線に合わせる。
- Jest は実行不可。PHP/ブラウザのスモークで確認し、未検証領域はドキュメント化する。

## スコープ（本イテレーションで着手）
1. メール送信・確認コードフローの完了
   - Mailer に SMTP/Sendmail 切替（ENV: `MAIL_TRANSPORT`, `MAIL_HOST` 等）を追加し、ロリポ環境で `mail()` 不可時のフォールバックを明記。
   - パスワードリセット/登録確認メールのテンプレートを整備し、件名・本文を日本語で統一（変数最小化、プレーンテキスト優先）。
   - RegisterVerify/PasswordReset のコントローラに送信ロジック・トークン保存/検証・再送ポリシーを実装。レートリミットは IP グローバル + IP×メール。

2. 認証・登録まわりの最終防御線
   - CSRF/入力正規化/maxlength/pattern のサーバー・ビュー整合を再確認し、429 or 303 の扱いを統一（Retry-After を適用する場合は実装）。
   - ログイン後/未ログイン時の遷移を既存と一致させ、セッション TTL/同時ログイン方針を反映（`docs/` に明記）。

3. レートリミット共有ストアの実装
   - APCu 非対応時の代替ストアを追加（MySQL またはファイルベース）。キー設計と TTL 精度、ファイル数上限の対策をドキュメント化。
   - RateLimiter を抽象化し、CLI/ウェブ両方で同一の実装を利用できるようにする。

4. UI パリティ調整
   - 主要画面（ログイン/登録/確認/リセット/ダッシュボード）の余白・フォント・カラー・ボタン位置を EJS 版と突き合わせ、`public/styles.css` のトークンをベースに微調整。
   - ナビ/パンくず/エラーメッセージの表記を日本語で統一し、モバイル幅での崩れを確認。

## アウトプット
- 実装コード（Mailer 拡張、認証/確認/リセットの完成、RateLimiter 抽象化、UI 微調整）。
- 日本語メールテンプレート（リセット・確認コード）。
- 簡易スモーク手順と実行可否の記録（Jest 代替）。
- 仕様差分・未対応領域のメモ（`docs/` に追記）。

## 検証方針（Jest は使わない）
- PHP ビルトインサーバーで `/health` `/status` `/login` `/register` `/password/reset` `/register/verify` をブラウザ/CLI で確認。
- Mailer: ログ出力と mail()/SMTP 呼び出しパスの例外ハンドリングを手動で確認（本番送信は不可環境で dry-run）。
- RateLimiter: CLI から単体呼び出しでキーごとのカウント挙動を確認（APCu/フォールバック両方）。

## リスクと対応
- メール送信可否が環境依存: ENV で transport を切替可能にし、不可時はログ＋UXで案内。
- レートリミットの共有ストア: MySQL/ファイルのパフォーマンス・ロックを確認し、負荷時の退避策を記載。
- UI 差分: 既存 EJS のスクリーンショット/仕様を参照し、トークン変更を最小限にする。
