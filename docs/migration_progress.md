# PHP移行 進捗メモ

## 今回対応
- APCu レートリミットを原子的インクリメント方式に変更し、ウィンドウ更新の競合や CAS 不整合で正当なリクエストが拒否される問題を解消。
- TRUST_PROXY のデフォルトを安全側に寄せた ClientIpResolver を追加し、パスワードリセットと確認コード再送の IP 取得を統一。
- パスワードリセット要求で IP 単位のグローバル制限 + IP×メール単位の制限を適用し、標的となるメールアドレスへの DoS を緩和。IP 取得に失敗した場合は処理を中断して案内を表示。
- メール確認ビューで CSRF トークンを必須化し、レートリミットも新しい IP 解決経路に載せ替え。
- パスワードリセットの本処理を実装（Repository 拡張 + PasswordResetService）。トークンを SHA-256 でハッシュ保存し、15 分有効・未使用・ユーザー active の場合のみ有効化。消費時にパスワード更新＋ロック解除/失敗回数リセットをトランザクションで行う。
- ローカル環境のみ、デバッグ用にトークンを flash と `php/storage/password_reset_debug.log` に記録（`.gitignore` 追加済み）。本番ではトークンを露出せず成功応答のみ返す。
- パスワード再設定画面は無効/期限切れ/使用済みトークンを弾き、更新成功時は `/login` へリダイレクトするように変更。リクエスト画面も CSRF → レートリミット → トークン発行の順で処理。
- Mailer を追加し、パスワードリセットメールを `storage/mail.log` に記録（本番では mail() も試行）。ENV の `MAIL_FROM_ADDRESS`/`MAIL_FROM_NAME` を使用。リセットリクエスト時にメール本文を生成し送信するよう変更。
- Mailer/ClientIpResolver/RateLimiter/静的配信のセキュリティ修正：From ヘッダの改行除去とメールログをハッシュ化してPIIを抑制、信頼プロキシ IP を ENV で制限しプライベートレンジを拒否、APCu レートリミットの窓リセット競合をCASで解消、静的ファイル配信でディレクトリトラバーサルを遮断。
- PasswordResetService にメール単位レートリミット（15分3回）を追加し、トークンハッシュのみログに記録。リセットリクエストのUIからデバッグトークン表示を削除。
- RegisterVerify の GET でメール不備は `/register` へ誘導し、ビューのバリデーションをコントローラ側に移動して CSRF/メールの整合性を保証。
- Mailer ログの件名もハッシュ化して残し、`TRUST_PROXY`/`TRUSTED_PROXIES` を .env.example に追加。

## 次にやること候補
- パスワードリセットのメール送信連携（SMTP設定反映、テンプレート整備、再送/失効ポリシーの運用決め）。
- メール確認コードの保存・検証と再送メール送信の実装（成功時にユーザーを有効化）。
- レートリミットの共有ストア検討（ロリポ環境で APCu が使えない場合に Redis/DB へ切替）。
- 認証/登録フォームまわりの CSRF・入力検証の最終レビューと EJS テンプレート移植開始。
- Jest が実行できないため、PHP 側の手動スモークシナリオと検証手順を書き起こす。
