# PHP実装 次ステップ計画（2025-11-23）

## 目的と前提
- `docs/php_next_steps.md` の **# 移行のゴール** を順守し、Node/Lambda 実装を PHP へ移行するだけで仕様差分を作らない。
- ロリポップ！スタンダードプラン前提（PHP 8.3/8.4、MySQL 8、アップロード上限100MB、OPcacheはCGI版のみ有効）。`lolipop_server_spec.html` と `migrate_php.md` の制約内で動作する構成を維持する。
- 既存のセキュリティ修正を崩さず、追加実装も CSRF/XSS/ヘッダインジェクション/レートリミットを考慮して最小リスクで進める。
- Jest テストは実行不能のため、PHP 側の CLI/ブラウザを用いたスモーク検証で代替し、検証不可領域はドキュメント化する。

## 現状の整理（`docs/migration_progress.md` より抜粋）
- Slim ベースの骨格、CSRF/flash/レイアウト/ログイン足場、`/health` `/status` `/web` `/dashboard` 等のルートを実装済み。
- パスワードリセットのトークンハッシュ保存・15分有効・使用済み無効化・トランザクション更新を実装。IP 解決とレートリミットの強化、CSRF とフォーム検証も実装済み。
- Mailer はログ＋オプションで `mail()` を呼び出し、宛先・件名はハッシュ化して記録し、ログの簡易ローテーションを追加済み。
- レートリミッターは APCu 対応（CAS で競合抑止）、TRUST_PROXY 設定によるクライアントIP解決を導入。

## 今後の実装計画（優先度順）
1. メール送信・確認コードフローの完成
   - SMTP/Sendmail設定を ENV から切り替えられるよう Mailer を拡張し、ロリポ環境で `mail()` が使えない場合の動作を検証・ドキュメント化。
   - パスワードリセットメールと登録確認メールのテンプレート整備（多言語未対応なら日本語固定で先行）、件名/本文の変数を最小限に。
   - メール確認コードの保存・検証・再送、成功時のユーザー有効化までを完結させ、レートリミットと CSRF を必須化。

2. 認証/登録フローの仕上げ
   - Register/PasswordReset 各コントローラの CSRF・入力正規化（メール小文字化・長さ制限）・ヘッダインジェクション防止を最終確認し、ビューの maxlength/pattern を仕様に合わせる。
   - 429 応答やリダイレクトコードを HTTP 標準に合わせて整理（429＋Retry-After もしくは 303 リダイレクトに統一）。
   - ログイン後動線や未ログインアクセスのガードを統一し、セッション TTL/同時ログインの運用ルールを決定・反映。

3. レートリミット共有ストアの選定と実装
   - ロリポ標準プランで APCu が利用できない場合の代替として、MySQL またはファイルベースの共有ストアを検証し、実装を抽象化。
   - 窓のリセットとキー設計（IP単位 + 正規化メール併用）を見直し、DoS/ターゲット枯渇を避けるポリシーを決定。
   - フォールバック時の注意点（マルチプロセス不整合、TTL精度、ファイル数上限対策）をドキュメント化。

4. テンプレート移植と画面整備
   - 既存 EJS を PHP ビューへ順次移植。優先度: 認証/登録 → ダッシュボード → 勤怠/給与 → 管理画面。
   - レイアウト共通パーツ（ヘッダ/ナビ/フラッシュ/CSRF埋め込み）を再利用し、CSS クラスとアクセシビリティ属性（id/for/aria）を整備。
   - UI デザインは既存環境に寄せることを最優先とし、現行 `public/styles.css` のトークン（色/余白/角丸/影）とコンポーネント構造（カード/ボタン/フォーム）を流用する。新規トークン追加は最小限にし、余白・フォントサイズ・行間を EJS 版と突き合わせて差異を排除。
   - ナビ/パンくず/フォームエラーメッセージの位置・色・アイコンの挙動を EJS と照合し、レスポンシブ（モバイル幅での縦積み、フォーム幅の上限）を確認。必要に応じて CSS 変数化し、レイアウト崩れが出ない範囲でのみ微調整する。
   - ファイル配信ルートを確認し、画像/JS/CSS/ico を `php/public` とリポジトリ直下 `public` の双方から安全に提供する。

5. バッチ・運用ジョブ
   - 既存 Node バッチ（データ保持/バックアップ）を PHP CLI + cron に移植。`scripts/purgeExpiredData.js` 相当の保持期間・世代ローテーションを 400GB/50万ファイル制限内で設計。
   - セッション/メールログ/パスワードリセットログのローテーションを自動化し、PII 最小化とストレージ抑制を両立。
   - 監視/ヘルスチェック用の簡易 CLI を用意し、稼働確認手順を `docs/` に追記。

6. データ移行と検証
   - `docs/php_mysql_schema.sql` に基づき Phinx/Laravel Migration 化を進め、ロリポ MySQL へ適用する手順を整備。
   - `docs/db_seed_local.sql` のシードをローカル/ステージング検証用に適用し、bcrypt互換やタイムゾーン（UTC）を確認。
   - Jest 代替として、PHP CLI でのユースケース別スモーク（ログイン→登録→リセット→ダッシュボード表示など）とブラウザ手動チェックのチェックリストを作成。

## 検証・リスク管理
- テスト: Jest は実行しない。PHP CLI/ブラウザ操作のスモーク手順を作り、実行可否もドキュメント化する。
- セキュリティ: CSRF/入力正規化/ヘッダ・メールの改行除去/ディレクトリトラバーサル防止を全ルートで再確認し、変更ごとに影響範囲を明記する。
- 運用: ロリポ標準プランの制約変更や mail() 可否は環境差があるため、デプロイ前に `lolipop_server_spec.html` を再確認し、想定差分は README/Docs に残す。
